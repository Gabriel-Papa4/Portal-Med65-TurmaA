<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATOLOGIA GERAL - Calculadora de Notas</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <h1>Calculadora de Notas</h1>
            <h2>4° Período</h2>
        </div>
    </header>

    <main class="container">
        <br>
        <a href="calculadora-hub.html" class="voltar">← Voltar para página inicial</a>
        
        <div class="calculadora">
            <h2>PATOLOGIA GERAL</h2>

            <div class="form-group" style="padding: 10px 20px; background-color: #eaf2fa; border-radius: 8px; margin-bottom: 20px; border: 1px solid #cfe0f3;">
                <label style="font-weight: bold; color: #0d47a1; font-size: 1.1rem;">Optou por fazer os questionários?</label>
                <div style="display: flex; gap: 20px; margin-top: 8px;">
                    <label for="com-questionarios" style="cursor:pointer; font-weight: normal; display: flex; align-items: center;"><input type="radio" id="com-questionarios" name="tipo-calculo" value="com" checked style="width: auto; margin-right: 5px;"> Sim</label>
                    <label for="sem-questionarios" style="cursor:pointer; font-weight: normal; display: flex; align-items: center;"><input type="radio" id="sem-questionarios" name="tipo-calculo" value="sem" style="width: auto; margin-right: 5px;"> Não</label>
                </div>
            </div>
            
            <form id="calculadora-form">
                <div id="com-questionarios-div">
                    <div class="grade-input-section">
                        <h4>P1 (Com Questionários)</h4>
                        <div class="form-group">
                            <label for="p1-q1">Questionário 1 (10 pts) - peso 1</label>
                            <input type="number" id="p1-q1" min="0" max="10" step="0.01" placeholder="Nota Questionário 1">
                        </div>
                        <div class="form-group">
                            <label for="p1-q2">Questionário 2 (10 pts) - peso 1</label>
                            <input type="number" id="p1-q2" min="0" max="10" step="0.01" placeholder="Nota Questionário 2">
                        </div>
                        <div class="form-group">
                            <label for="p1-escrita-com">Avaliação Escrita 1 (10 pts) - peso 5</label>
                            <input type="number" id="p1-escrita-com" min="0" max="10" step="0.01" placeholder="Nota Avaliação Escrita 1">
                        </div>
                    </div>
                    <div class="grade-input-section">
                        <h4>P2 (Com Questionários)</h4>
                        <div class="form-group">
                            <label for="p2-q3">Questionário 3 (10 pts) - peso 1</label>
                            <input type="number" id="p2-q3" min="0" max="10" step="0.01" placeholder="Nota Questionário 3">
                        </div>
                        <div class="form-group">
                            <label for="p2-q4">Questionário 4 (10 pts) - peso 1</label>
                            <input type="number" id="p2-q4" min="0" max="10" step="0.01" placeholder="Nota Questionário 4">
                        </div>
                        <div class="form-group">
                            <label for="p2-escrita-com">Avaliação Escrita 2 (10 pts) - peso 5</label>
                            <input type="number" id="p2-escrita-com" min="0" max="10" step="0.01" placeholder="Nota Avaliação Escrita 2">
                        </div>
                    </div>
                </div>

                <div id="sem-questionarios-div" style="display: none;">
                    <div class="grade-input-section">
                        <div class="grade-input-group main-grade">
                            <label for="p1-sem">P1 - Avaliação Escrita 1 (10 pontos)</label>
                            <input type="number" id="p1-sem" min="0" max="10" step="0.01" placeholder="Nota Avaliação Escrita 1">
                        </div>
                    </div>
                    <div class="grade-input-section">
                        <div class="grade-input-group main-grade">
                             <label for="p2-sem">P2 - Avaliação Escrita 2 (10 pontos)</label>
                            <input type="number" id="p2-sem" min="0" max="10" step="0.01" placeholder="Nota Avaliação Escrita 2">
                        </div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button type="button" id="calcular" class="btn-calcular">Calcular</button>
                    <button type="button" id="limpar" class="btn-limpar">Limpar</button>
                </div>
            </form>
            
            <div id="resultado" class="resultado" style="display: none;">
                <h3>Resultado:</h3>
                <div id="media-final" style="display: none;">
                    <p>Sua média final é: <strong id="nota-final">0.00</strong></p>
                    <p id="mensagem"></p>
                </div>
                <div id="notas-necessarias"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Autoria de Gabriel Papa</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calcularBtn = document.getElementById('calcular');
            const limparBtn = document.getElementById('limpar');
            
            if (calcularBtn) calcularBtn.addEventListener('click', calcularNota);
            if (limparBtn) limparBtn.addEventListener('click', () => limparCampos(document.getElementById('calculadora-form')));

            const radios = document.querySelectorAll('input[name="tipo-calculo"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('com-questionarios-div').style.display = this.value === 'com' ? 'block' : 'none';
                    document.getElementById('sem-questionarios-div').style.display = this.value === 'sem' ? 'block' : 'none';
                });
            });
        });
        
        function getNota(id) {
            const val = document.getElementById(id).value;
            return val !== '' ? parseFloat(val) : null;
        }

        function calcularNota() {
            const tipoCalculo = document.querySelector('input[name="tipo-calculo"]:checked').value;
            let p1 = null, p2 = null;

            // Variáveis para componentes da P1 e P2
            let p1q1 = null, p1q2 = null, p1escritaCom = null;
            let p2q3 = null, p2q4 = null, p2escritaCom = null;
            let p1sem = null, p2sem = null;

            if (tipoCalculo === 'com') {
                p1q1 = getNota('p1-q1');
                p1q2 = getNota('p1-q2');
                p1escritaCom = getNota('p1-escrita-com');
                if (p1q1 !== null && p1q2 !== null && p1escritaCom !== null) {
                    p1 = ((p1q1 * 1) + (p1q2 * 1) + (p1escritaCom * 5)) / 7;
                }

                p2q3 = getNota('p2-q3');
                p2q4 = getNota('p2-q4');
                p2escritaCom = getNota('p2-escrita-com');
                if (p2q3 !== null && p2q4 !== null && p2escritaCom !== null) {
                    p2 = ((p2q3 * 1) + (p2q4 * 1) + (p2escritaCom * 5)) / 7;
                }
            } else {
                p1sem = getNota('p1-sem');
                p2sem = getNota('p2-sem');
                p1 = p1sem;
                p2 = p2sem;
            }
            
            const notasNecessariasDiv = document.getElementById('notas-necessarias');
            const mediaFinalDiv = document.getElementById('media-final');
            const notaFinalEl = document.getElementById('nota-final');
            const mensagemEl = document.getElementById('mensagem');
            const resultadoDiv = document.getElementById('resultado');

            notasNecessariasDiv.innerHTML = '';
            mediaFinalDiv.style.display = 'none';
            mediaFinalDiv.classList.remove('aprovado', 'recuperacao', 'reprovado');
            mensagemEl.className = ''; 
            notaFinalEl.textContent = '0.00';
            const linkPfWrapper = mediaFinalDiv.querySelector('.link-pf-wrapper');
            if (linkPfWrapper) linkPfWrapper.remove();
            
            const PASSING_GRADE = 7;

            if (p1 !== null && !isNaN(p1) && p2 !== null && !isNaN(p2)) {
                const mediaFinalValor = (p1 + p2) / 2;
                notaFinalEl.textContent = formatarNota(mediaFinalValor);
                mensagemEl.textContent = obterMensagem(mediaFinalValor);
                
                if (mediaFinalValor >= PASSING_GRADE) {
                    mediaFinalDiv.classList.add('aprovado');
                    mensagemEl.classList.add('aprovado-msg');
                } else if (mediaFinalValor >= 3) {
                    mediaFinalDiv.classList.add('recuperacao');
                    mensagemEl.classList.add('recuperacao-msg');
                    let linkPfWrapperLocal = mediaFinalDiv.querySelector('.link-pf-wrapper');
                    if (!linkPfWrapperLocal) {
                        linkPfWrapperLocal = document.createElement('p');
                        linkPfWrapperLocal.className = 'link-pf-wrapper';
                        linkPfWrapperLocal.innerHTML = `<a href="prova-final.html" class="btn-calcular btn-calcular-pf" style="display: inline-block; margin-top: 10px; text-decoration: none; text-align: center;">Cálculo da Prova Final</a>`;
                        mediaFinalDiv.appendChild(linkPfWrapperLocal);
                    }
                } else {
                    mediaFinalDiv.classList.add('reprovado');
                    mensagemEl.classList.add('reprovado-msg');
                }
                mediaFinalDiv.style.display = 'block';
                notasNecessariasDiv.style.display = 'none';
            } else {
                mediaFinalDiv.style.display = 'none';
                notasNecessariasDiv.style.display = 'block';
                let htmlNotasNecessarias = '<h4>Notas necessárias para média 7:</h4><ul>';

                const notasAlvoParaPx = {};
                const TOTAL_PX = 2;
                
                let pontosAtuais = 0;
                let numPxPreenchidas = 0;

                if (p1 !== null && !isNaN(p1)) {
                    pontosAtuais += p1;
                    numPxPreenchidas++;
                }
                if (p2 !== null && !isNaN(p2)) {
                    pontosAtuais += p2;
                    numPxPreenchidas++;
                }
                
                let pontosFaltantesParaMedia7 = (PASSING_GRADE * TOTAL_PX) - pontosAtuais;
                let notaNecessariaGeral = pontosFaltantesParaMedia7 / (TOTAL_PX - numPxPreenchidas);
                
                let isPossibleToReach7 = notaNecessariaGeral <= 10.005;
                notaNecessariaGeral = Math.max(0, Math.min(10, notaNecessariaGeral));

                if (p1 === null || isNaN(p1)) notasAlvoParaPx['P1'] = notaNecessariaGeral;
                if (p2 === null || isNaN(p2)) notasAlvoParaPx['P2'] = notaNecessariaGeral;

                if (!isPossibleToReach7) {
                    htmlNotasNecessarias += `<li>Com as notas atuais, não é possível atingir média 7.</li>`;
                }

                if (p1 === null || isNaN(p1)) {
                    htmlNotasNecessarias += `<li>P1: <strong>${formatarNota(notasAlvoParaPx['P1'])}</strong></li>`;
                    if (tipoCalculo === 'com') {
                        const p1Comps = [
                            {nome: "Questionário 1", peso: 1, max: 10, nota: p1q1},
                            {nome: "Questionário 2", peso: 1, max: 10, nota: p1q2},
                            {nome: "Avaliação Escrita 1", peso: 5, max: 10, nota: p1escritaCom}
                        ];
                        htmlNotasNecessarias += calcularNotasComponentesPatologia(p1Comps, notasAlvoParaPx['P1'], 'P1');
                    }
                }
                if (p2 === null || isNaN(p2)) {
                    htmlNotasNecessarias += `<li>P2: <strong>${formatarNota(notasAlvoParaPx['P2'])}</strong></li>`;
                    if (tipoCalculo === 'com') {
                        const p2Comps = [
                            {nome: "Questionário 3", peso: 1, max: 10, nota: p2q3},
                            {nome: "Questionário 4", peso: 1, max: 10, nota: p2q4},
                            {nome: "Avaliação Escrita 2", peso: 5, max: 10, nota: p2escritaCom}
                        ];
                        htmlNotasNecessarias += calcularNotasComponentesPatologia(p2Comps, notasAlvoParaPx['P2'], 'P2');
                    }
                }
                
                htmlNotasNecessarias += '</ul>';
                notasNecessariasDiv.innerHTML = htmlNotasNecessarias;
            }
            resultadoDiv.style.display = 'block';
        }

        function calcularNotasComponentesPatologia(componentes, targetNotaDaPx, pxNome) {
            const compsFaltando = componentes.filter(c => c.nota === null);
            if (compsFaltando.length === 0) return '';

            let html = `<li style="list-style-type: none;"><strong>--- Para ${pxNome} atingir ${formatarNota(targetNotaDaPx)} (com questionários) ---</strong></li>`;
            
            let somaPonderadaAtual = 0;
            componentes.forEach(c => {
                if (c.nota !== null) {
                    somaPonderadaAtual += c.nota * c.peso;
                }
            });

            const somaPonderadaTotalNecessaria = targetNotaDaPx * 7;
            const somaPonderadaAindaNecessaria = somaPonderadaTotalNecessaria - somaPonderadaAtual;

            let somaPonderadaMaxFaltante = 0;
            compsFaltando.forEach(c => {
                somaPonderadaMaxFaltante += c.max * c.peso;
            });

            if (somaPonderadaAindaNecessaria > somaPonderadaMaxFaltante + 0.005) {
                 compsFaltando.forEach(c => {
                    html += `<li style="list-style-type: '→ '; padding-left: 10px;">${c.nome}: <strong>${formatarNota(c.max)}</strong> (de ${c.max}) (Insuficiente)</li>`;
                });
                return html;
            }

            compsFaltando.forEach(c => {
                let notaNecessaria = 0;
                if (somaPonderadaMaxFaltante > 0) {
                    const proporcao = (c.max * c.peso) / somaPonderadaMaxFaltante;
                    const pontosPonderadosParaEsteComp = somaPonderadaAindaNecessaria * proporcao;
                    notaNecessaria = pontosPonderadosParaEsteComp / c.peso;
                }
                html += `<li style="list-style-type: '→ '; padding-left: 10px;">${c.nome}: <strong>${formatarNota(Math.max(0, Math.min(c.max, notaNecessaria)))}</strong> (de ${c.max})</li>`;
            });

            return html;
        }
    </script>
</body>
</html>