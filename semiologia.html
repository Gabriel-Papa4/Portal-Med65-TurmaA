<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEMIOLOGIA I - Calculadora de Notas</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <h1>Calculadora de Notas</h1>
            <h2>4° Período</h2>
        </div>
    </header>

    <main class="container">
        <br>
        <a href="calculadora-hub.html" class="voltar">← Voltar para página inicial</a>

        <div class="calculadora">
            <h2>SEMIOLOGIA I</h2>

            <form id="calculadora-form">
                <div class="grade-input-section">
                    <div class="grade-input-group main-grade p1-toggle-header" data-target-details="p1ComponentsDetailsSemiologia">
                        <label for="p1-completa">P1 (10 pontos):</label>
                        <input type="number" id="p1-completa" min="0" max="10" step="0.01" placeholder="Digite a nota da P1">
                        <span class="p1-components-label-action">CALCULAR P1 POR COMPONENTES</span>
                        <button type="button" class="expand-arrow-button">
                            <span class="arrow-icon">▼</span>
                        </button>
                    </div>
                    <div class="p1-components-details" id="p1ComponentsDetailsSemiologia" style="display: none;">
                        <div class="form-group">
                            <label for="p1-longitudinal">
                                <span>Ficha de Avaliação Longitudinal I</span>
                                <span class="points-label">(3,0 pontos)</span>
                            </label>
                            <input type="number" id="p1-longitudinal" min="0" max="3" step="0.01" placeholder="Nota da Ficha Longitudinal I">
                        </div>
                        <div class="form-group">
                            <label for="p1-teorica">
                                <span>Prova Teórica I</span>
                                <span class="points-label">(3,0 pontos)</span>
                            </label>
                            <input type="number" id="p1-teorica" min="0" max="3" step="0.01" placeholder="Nota da Prova Teórica I">
                        </div>
                        <div class="form-group">
                            <label for="p1-anamnese">
                                <span>Prova Anamnese I</span>
                                <span class="points-label">(2,0 pontos)</span>
                            </label>
                            <input type="number" id="p1-anamnese" min="0" max="2" step="0.01" placeholder="Nota da Prova Anamnese I">
                        </div>
                        <div class="form-group">
                            <label for="p1-pratica">
                                <span>Prova Prática I</span>
                                <span class="points-label">(2,0 pontos)</span>
                            </label>
                            <input type="number" id="p1-pratica" min="0" max="2" step="0.01" placeholder="Nota da Prova Prática I">
                        </div>
                    </div>
                </div>

                <div class="grade-input-section">
                    <div class="grade-input-group main-grade p2-toggle-header" data-target-details="p2ComponentsDetailsSemiologia">
                        <label for="p2-completa">P2 (10 pontos):</label>
                        <input type="number" id="p2-completa" min="0" max="10" step="0.01" placeholder="Digite a nota da P2">
                        <span class="p2-components-label-action">CALCULAR P2 POR COMPONENTES</span>
                        <button type="button" class="expand-arrow-button">
                            <span class="arrow-icon">▼</span>
                        </button>
                    </div>
                    <div class="p2-components-details" id="p2ComponentsDetailsSemiologia" style="display: none;">
                        <div class="form-group">
                            <label for="p2-longitudinal">
                                <span>Ficha de Avaliação Longitudinal II</span>
                                <span class="points-label">(2,5 pontos)</span>
                            </label>
                            <input type="number" id="p2-longitudinal" min="0" max="2.5" step="0.01" placeholder="Nota da Ficha Longitudinal II">
                        </div>
                        <div class="form-group">
                            <label for="p2-teorica">
                                <span>Prova Teórica II</span>
                                <span class="points-label">(2,5 pontos)</span>
                            </label>
                            <input type="number" id="p2-teorica" min="0" max="2.5" step="0.01" placeholder="Nota da Prova Teórica II">
                        </div>
                         <div class="form-group">
                            <label for="p2-anamnese">
                                <span>Prova Anamnese II</span>
                                <span class="points-label">(2,0 pontos)</span>
                            </label>
                            <input type="number" id="p2-anamnese" min="0" max="2" step="0.01" placeholder="Nota da Prova Anamnese II">
                        </div>
                        <div class="form-group">
                            <label for="p2-pratica">
                                <span>Prova Prática II</span>
                                <span class="points-label">(2,0 pontos)</span>
                            </label>
                            <input type="number" id="p2-pratica" min="0" max="2" step="0.01" placeholder="Nota da Prova Prática II">
                        </div>
                        <div class="form-group">
                            <label for="p2-portfolio">
                                <span>E-Portfólio</span>
                                <span class="points-label">(1,0 ponto)</span>
                            </label>
                            <input type="number" id="p2-portfolio" min="0" max="1" step="0.01" placeholder="Nota do E-Portfólio">
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button type="button" id="calcular" class="btn-calcular">Calcular</button>
                    <button type="button" id="limpar" class="btn-limpar">Limpar</button>
                </div>
            </form>

            <div id="resultado" class="resultado" style="display: none;">
                <h3>Resultado:</h3>
                <div id="media-final" style="display: none;" class="media-final-wrapper">
                    <p>Sua média final é: <strong id="nota-final">0.00</strong></p>
                    <p id="mensagem"></p>
                </div>
                <div id="notas-necessarias"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Autoria de Gabriel Papa</p>
        </div>
    </footer>

<script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calcularBtn = document.getElementById('calcular');
            const limparBtn = document.getElementById('limpar');
            if (calcularBtn) calcularBtn.addEventListener('click', calcularNota);
            if (limparBtn) limparBtn.addEventListener('click', () => limparCampos(document.getElementById('calculadora-form')));
        });
        
        function getNota(id) {
            const val = document.getElementById(id).value;
            return val !== '' ? parseFloat(val) : null;
        }

        function calculateMissingForPx(target, components) {
            let html = '';
            let currentSum = 0;
            const missing = components.filter(c => c.v === null);
            components.filter(c => c.v !== null).forEach(c => currentSum += c.v);

            if (missing.length === 0) return '';

            const neededSum = target - currentSum;
            const maxMissingSum = missing.reduce((sum, c) => sum + c.m, 0);

            if (neededSum > maxMissingSum + 0.01) {
                return false; // Sinaliza que é impossível
            }

            missing.forEach(comp => {
                const proportion = maxMissingSum > 0 ? comp.m / maxMissingSum : 0;
                const neededScore = neededSum * proportion;
                html += `<li style="list-style-type: '→ '; padding-left: 10px;">${comp.n}: <strong>${formatarNota(Math.max(0, Math.min(comp.m, neededScore)))}</strong> (de ${comp.m.toFixed(1)})</li>`;
            });
            return html;
        }

        function calcularNota() {
            // P1
            let p1 = getNota('p1-completa');
            const p1Long = getNota('p1-longitudinal'), p1Teo = getNota('p1-teorica'), p1Anam = getNota('p1-anamnese'), p1Prat = getNota('p1-pratica');
            if (p1 === null && [p1Long, p1Teo, p1Anam, p1Prat].every(n => n !== null)) {
                p1 = p1Long + p1Teo + p1Anam + p1Prat;
            }

            // P2
            let p2 = getNota('p2-completa');
            const p2Long = getNota('p2-longitudinal'), p2Teo = getNota('p2-teorica'), p2Anam = getNota('p2-anamnese'), p2Prat = getNota('p2-pratica'), p2Port = getNota('p2-portfolio');
            if (p2 === null && [p2Long, p2Teo, p2Anam, p2Prat, p2Port].every(n => n !== null)) {
                p2 = p2Long + p2Teo + p2Anam + p2Prat + p2Port;
            }

            const resultadoDiv = document.getElementById('resultado');
            const mediaFinalDiv = document.getElementById('media-final');
            const notasNecessariasDiv = document.getElementById('notas-necessarias');
            const notaFinalEl = document.getElementById('nota-final');
            const mensagemEl = document.getElementById('mensagem');

            mediaFinalDiv.style.display = 'none';
            notasNecessariasDiv.innerHTML = '';
            mediaFinalDiv.classList.remove('aprovado', 'recuperacao', 'reprovado');
            mensagemEl.className = '';
            const linkPfWrapper = mediaFinalDiv.querySelector('.link-pf-wrapper');
            if (linkPfWrapper) linkPfWrapper.remove();
            
            const PASSING_GRADE = 7;

            if (p1 !== null && p2 !== null) {
                notasNecessariasDiv.style.display = 'none';
                mediaFinalDiv.style.display = 'block';

                const mediaFinalValor = (p1 + p2) / 2;
                notaFinalEl.textContent = formatarNota(mediaFinalValor);
                mensagemEl.textContent = obterMensagem(mediaFinalValor);

                if (mediaFinalValor >= PASSING_GRADE) {
                    mediaFinalDiv.classList.add('aprovado');
                    mensagemEl.classList.add('aprovado-msg');
                } else if (mediaFinalValor >= 3) {
                    mediaFinalDiv.classList.add('recuperacao');
                    mensagemEl.classList.add('recuperacao-msg');
                    const linkPf = document.createElement('p');
                    linkPf.className = 'link-pf-wrapper';
                    linkPf.innerHTML = `<a href="prova-final.html" class="btn-calcular" style="display: inline-block; margin-top: 10px; text-decoration: none; text-align: center;">Cálculo da Prova Final</a>`;
                    mediaFinalDiv.appendChild(linkPf);
                } else {
                    mediaFinalDiv.classList.add('reprovado');
                    mensagemEl.classList.add('reprovado-msg');
                }
            } else {
                mediaFinalDiv.style.display = 'none';
                notasNecessariasDiv.style.display = 'block';
                
                let min_p1 = (p1 !== null) ? p1 : ([p1Long, p1Teo, p1Anam, p1Prat].filter(n=>n!==null).reduce((a,b)=>a+b,0));
                let min_p2 = (p2 !== null) ? p2 : ([p2Long, p2Teo, p2Anam, p2Prat, p2Port].filter(n=>n!==null).reduce((a,b)=>a+b,0));
                
                if ((min_p1 + min_p2) / 2 >= PASSING_GRADE) {
                    notasNecessariasDiv.innerHTML = '<h4>Resultado:</h4><p class="aprovado-msg" style="font-weight: bold;">Parabéns, você já passou!</p>';
                } else {
                    let htmlOutput = '';
                    if (p1 !== null) { htmlOutput += `<p style="font-weight: bold;">P1 (geral): ${formatarNota(p1)}</p>`; }
                    if (p2 !== null) { htmlOutput += `<p style="font-weight: bold;">P2 (geral): ${formatarNota(p2)}</p>`; }
                    htmlOutput += '<h4>Notas necessárias para média 7:</h4><ul>';
                    
                    const p1Comps = [
                        {n:'Ficha de Avaliação Longitudinal I',m:3,v:p1Long}, {n:'Prova Teórica I',m:3,v:p1Teo},
                        {n:'Prova Anamnese I',m:2,v:p1Anam}, {n:'Prova Prática I',m:2,v:p1Prat}
                    ];
                    const p2Comps = [
                        {n:'Ficha de Avaliação Longitudinal II',m:2.5,v:p2Long}, {n:'Prova Teórica II',m:2.5,v:p2Teo},
                        {n:'Prova Anamnese II',m:2,v:p2Anam}, {n:'Prova Prática II',m:2,v:p2Prat}, {n:'E-Portfólio',m:1,v:p2Port}
                    ];

                    if (p1 === null && p2 === null) {
                        const p1Calc = calculateMissingForPx(7, p1Comps);
                        if (p1Calc === false) {
                           htmlOutput += '<li>Com as notas atuais para P1, não é possível atingir a nota necessária.</li>';
                        } else {
                            htmlOutput += `<li style="list-style-type: none;"><strong>--- Para P1 atingir ~7.00 ---</strong></li>`;
                            htmlOutput += p1Calc;
                        }
                         const p2Calc = calculateMissingForPx(7, p2Comps);
                        if (p2Calc === false) {
                            htmlOutput += '<li>Com as notas atuais para P2, não é possível atingir a nota necessária.</li>';
                        } else {
                            htmlOutput += `<li style="list-style-type: none;"><strong>--- Para P2 atingir ~7.00 ---</strong></li>`;
                            htmlOutput += p2Calc;
                        }
                    } else if (p1 !== null) {
                        const neededP2 = 14 - p1;
                        const p2CalculationHtml = calculateMissingForPx(neededP2, p2Comps);
                        if(p2CalculationHtml === false){
                            htmlOutput += '<li>Com as notas atuais, não é possível atingir média 7.</li>';
                        } else {
                            htmlOutput += `<li style="list-style-type: none;"><strong>--- Para P2 atingir ~${formatarNota(neededP2)} ---</strong></li>`;
                            htmlOutput += p2CalculationHtml;
                        }
                    } else { // p2 !== null
                        const neededP1 = 14 - p2;
                        const p1CalculationHtml = calculateMissingForPx(neededP1, p1Comps);
                         if (p1CalculationHtml === false) {
                            htmlOutput += '<li>Com as notas atuais, não é possível atingir média 7.</li>';
                        } else {
                            htmlOutput += `<li style="list-style-type: none;"><strong>--- Para P1 atingir ~${formatarNota(neededP1)} ---</strong></li>`;
                            htmlOutput += p1CalculationHtml;
                        }
                    }
                    
                    htmlOutput += '</ul>';
                    notasNecessariasDiv.innerHTML = htmlOutput;
                }
            }
            resultadoDiv.style.display = 'block';
        }
    </script>
</body>
</html>
